<h1>Search Food:</h1>

<form class="pure-form" id="new-search" action="/" method="post">
  <input type="text" id="new-food" name="content" placeholder="Search" required>
  <button class='pure-button' type="submit" id="add-food">Submit</button>
</form>

<br><br><br><br>

<div class="container">
<div class="row col-md-8">

</div>

<table id="results-table" class="table table-hover table-bordered table-responsive">
  <thead>
    <tr>
      <th width="10%"></th>
      <th width="20%">Brand</th>
      <th width="15%">Serving Size</th>
      <th width="13%">Calories</th>
      <th width="13%">Protein</th>
      <th width="13%">Fat</th>
      <th width="15%">Carbohydrates</th>
    </tr>
  </thead>

  <tbody id="results-tbody">

  </tbody>
</table>
<br><br><br><br><br><br>

<table id="breakfast-table" class="table table-hover table-bordered table-responsive">
  <thead>
    <tr>
      <th width="10%"></th>
      <th width="20%">Brand</th>
      <th width="15%">Serving Size</th>
      <th width="13%">Calories</th>
      <th width="13%">Protein</th>
      <th width="13%">Fat</th>
      <th width="15%">Carbohydrates</th>
    </tr>
  </thead>

  <tbody id="breakfast-tbody">

  </tbody>
</table>

<table id="lunch-table" class="table table-hover table-bordered table-responsive">
  <thead>
    <tr>
      <th width="10%"></th>
      <th width="20%">Brand</th>
      <th width="15%">Serving Size</th>
      <th width="13%">Calories</th>
      <th width="13%">Protein</th>
      <th width="13%">Fat</th>
      <th width="15%">Carbohydrates</th>
    </tr>
  </thead>

  <tbody id="lunch-tbody">

  </tbody>
</table>

<table id="dinner-table" class="table table-hover table-bordered table-responsive">
  <thead>
    <tr>
      <th width="10%"></th>
      <th width="20%">Brand</th>
      <th width="15%">Serving Size</th>
      <th width="13%">Calories</th>
      <th width="13%">Protein</th>
      <th width="13%">Fat</th>
      <th width="15%">Carbohydrates</th>
    </tr>
  </thead>

  <tbody id="dinner-tbody">

  </tbody>
</table>

<table id="snack-table" class="table table-hover table-bordered table-responsive">
  <thead>
    <tr>
      <th width="10%"></th>
      <th width="20%">Brand</th>
      <th width="15%">Serving Size</th>
      <th width="13%">Calories</th>
      <th width="13%">Protein</th>
      <th width="13%">Fat</th>
      <th width="15%">Carbohydrates</th>
    </tr>
  </thead>

  <tbody id="snack-tbody">

  </tbody>
</table>

</div>
</div>

<script type="text/javascript">
var resultsTableBody = $('#results-table #results-tbody')
var breakfastTableBody = $('#breakfast-table #breakfast-tbody')
var lunchTableBody = $('#lunch-table #lunch-tbody')
var dinnerTableBody = $('#dinner-table #dinner-tbody')
var snackTableBody = $('#snack-table #snack-tbody')
var submit = $('#add-food')
var logTableBody = $('#log-table #log-tbody')

submit.on('click', function(evt){
  evt.preventDefault();
})

// $('#new-food').keyup(function(text){
submit.on('click', function(text){
  resultsTableBody.empty()
  var inputValue = $('#new-food').val();
  // var inputValue = this.value
  var foodSearch = {
    appId:"027e373f",
    appKey:"4d32fcc05f9358d893602b98daa6a6f7",
    query: inputValue,
    fields:["item_name","brand_name","nf_serving_size_qty", "nf_serving_size_unit", "nf_calories", "nf_protein", "nf_total_fat", "nf_total_carbohydrate", "images_front_full_url"],
    sort:{
      field:"_score",
      order:"desc"
    },
    filters:{
      item_type:2
    }
  }

  if (inputValue) {
    $.ajax({
      url: '/',
      method: 'POST',
      json: true,
      data: foodSearch
    }).done(function(data){
      console.log(data);
      for (var i = 0; i < data.hits.length; i ++){
        resultsTableBody.append('<tr id="' + data.hits[i]._id + '"><td><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Add Food<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#" class="breakfast">Breakfast</a></li><li><a class="lunch" href="#">Lunch</a></li><li><a class="dinner" href="#">Dinner</a></li><li><a class="snack" href="#">Snack</a></li></ul></div></td><td>' +
        data.hits[i].fields.brand_name + '</td><td>' + data.hits[i].fields.nf_serving_size_qty + ' ' + data.hits[i].fields.nf_serving_size_unit + '</td><td>' + data.hits[i].fields.nf_calories + '</td><td>' +
        data.hits[i].fields.nf_protein + '</td><td>' + data.hits[i].fields.nf_total_fat + '</td><td>' +
        data.hits[i].fields.nf_total_carbohydrate + '</td></tr>')
      }
    })
  }
})


$('body').on("click", ".breakfast", function(e){
  e.preventDefault()
  console.log("hello")
  btn = $(this)
  itemId = btn.parent().parent().attr('id')
  fields = btn.parent().parent().parent().parent().siblings();
  servingData = fields[1].innerText.split(' ');
  var data = {};
  data.meal = "breakfast"
  data.brand = fields[0].innerText
  data.servingSize = servingData[0]
  data.servingSizeUnits = servingData[1]
  data.calories = fields[2].innerText
  data.protein = fields[3].innerText
  data.fat = fields[4].innerText
  data.carbohydrates = fields[5].innerText
  $.ajax({
    url: '/user/<%= user._id %>/food',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data)
  }).done(function(data){
    console.log(data.user);
    foodArr = data.user.food
    var last = foodArr[data.user.food.length-1];
    breakfastTableBody.append('<tr id="' + itemId + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + last.brand + '</td><td>' +
    last.servingSize + ' ' + last.servingSizeUnits + '</td><td>' + last.calories + '</td><td>' +
    last.protein + '</td><td>' + last.fat + '</td><td>' +
    last.carbohydrates + '</td></tr>')
  })
})

$('body').on("click", ".lunch", function(e){
  e.preventDefault()
  console.log("hello")
  btn = $(this)
  itemId = btn.parent().parent().attr('id')
  fields = btn.parent().parent().parent().parent().siblings();
  servingData = fields[1].innerText.split(' ');
  console.log(fields)
  var data = {};
  data.meal = "lunch"
  data.brand = fields[0].innerText
  data.servingSize = servingData[0]
  data.servingSizeUnits = servingData[1]
  data.calories = fields[2].innerText
  data.protein = fields[3].innerText
  data.fat = fields[4].innerText
  data.carbohydrates = fields[5].innerText
  $.ajax({
    url: '/user/<%= user._id %>/food',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data)
  }).done(function(data){
    console.log(data.user);
    foodArr = data.user.food
    var last = foodArr[data.user.food.length-1];
    lunchTableBody.append('<tr id="' + itemId + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + last.brand + '</td><td>' +
    last.servingSize + ' ' + last.servingSizeUnits + '</td><td>' + last.calories + '</td><td>' +
    last.protein + '</td><td>' + last.fat + '</td><td>' +
    last.carbohydrates + '</td></tr>')
  })
})

$('body').on("click", ".dinner", function(e){
  e.preventDefault()
  console.log("hello")
  btn = $(this)
  itemId = btn.parent().parent().attr('id')
  fields = btn.parent().parent().parent().parent().siblings();
  servingData = fields[1].innerText.split(' ');
  console.log(fields)
  var data = {};
  data.meal = "dinner"
  data.brand = fields[0].innerText
  data.servingSize = servingData[0]
  data.servingSizeUnits = servingData[1]
  data.calories = fields[2].innerText
  data.protein = fields[3].innerText
  data.fat = fields[4].innerText
  data.carbohydrates = fields[5].innerText
  $.ajax({
    url: '/user/<%= user._id %>/food',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data)
  }).done(function(data){
    console.log(data.user);
    foodArr = data.user.food
    var last = foodArr[data.user.food.length-1];
    dinnerTableBody.append('<tr id="' + itemId + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + last.brand + '</td><td>' +
    last.servingSize + ' ' + last.servingSizeUnits + '</td><td>' + last.calories + '</td><td>' +
    last.protein + '</td><td>' + last.fat + '</td><td>' +
    last.carbohydrates + '</td></tr>')
  })
})

$('body').on("click", ".snack", function(e){
  e.preventDefault()
  btn = $(this)
  itemId = btn.parent().parent().attr('id')
  fields = btn.parent().parent().parent().parent().siblings();
  servingData = fields[1].innerText.split(' ');
  var data = {};
  data.meal = "snack"
  data.brand = fields[0].innerText
  data.servingSize = servingData[0]
  data.servingSizeUnits = servingData[1]
  data.calories = fields[2].innerText
  data.protein = fields[3].innerText
  data.fat = fields[4].innerText
  data.carbohydrates = fields[5].innerText
  console.log(data);
  $.ajax({
    url: '/user/<%= user._id %>/food',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data)
  }).done(function(data){
    // console.log(data.user.food[data.user.food.length-1].meal);
    foodArr = data.user.food
    var last = foodArr[data.user.food.length-1];
    snackTableBody.append('<tr id="' + itemId + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + last.brand + '</td><td>' +
    last.servingSize + ' ' + last.servingSizeUnits + '</td><td>' + last.calories + '</td><td>' +
    last.protein + '</td><td>' + last.fat + '</td><td>' +
    last.carbohydrates + '</td></tr>');
  })
})

$.ajax({
  url: '/user/<%= user._id %>/food',
  method: 'GET',
})
.done(function(data){
  var foodArr = data.food
  for (var i = 0; i < data.food.length; i++) {
    //if (data.food[i].meal == 'breakfast')
    $('#' + data.food[i].meal + '-tbody').append('<tr id="' + data.food[i]._id + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + foodArr[i].brand + '</td><td>' +
    foodArr[i].servingSize + ' ' + foodArr[i].servingSizeUnits + '</td><td>' + foodArr[i].calories + '</td><td>' +
    foodArr[i].protein + '</td><td>' + foodArr[i].fat + '</td><td>' +
    foodArr[i].carbohydrates + '</td></tr>')
  }
})

$('body').on('click', '.delete', function(){
 var btn = $(this)
 var itemId = btn.parent().parent().attr('id')
 $.ajax({
   url: '/user/<%= user._id %>/food/' + itemId,
   method: 'DELETE'
 })
   .done(function(data){
    btn.parent().parent().slideUp(function(){
    btn.parent().parent().remove();
    })
   })
})


</script>
